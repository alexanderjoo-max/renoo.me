<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Prefill destination IATA — must run BEFORE the WL script -->
  <script>
    (function() {
      // ---------------------------------------------------------------------------
      // City / IATA maps
      // ---------------------------------------------------------------------------
      var CITY_IATA = {
        'Bangkok':'BKK','Ho Chi Minh City':'SGN','Kuala Lumpur':'KUL','Bali':'DPS',
        'Jakarta':'CGK','Manila':'MNL','Singapore':'SIN','Seoul':'ICN','Tokyo':'NRT',
        'Beijing':'PEK','Shanghai':'PVG','Hong Kong':'HKG','Taipei':'TPE',
        'Delhi':'DEL','Mumbai':'BOM','Istanbul':'IST','Bodrum':'BAL','Dubai':'DXB',
        'Tel Aviv':'TLV','Cairo':'CAI','London':'LHR','Paris':'CDG','Amsterdam':'AMS',
        'Brussels':'BRU','Dublin':'DUB','Luxembourg':'LXG','Berlin':'TXL','Vienna':'VIE',
        'Zurich':'ZRH','Prague':'PRG','Warsaw':'WAW','Budapest':'BUD','Bratislava':'BTS',
        'Zagreb':'ZAG','Ljubljana':'LJU','Rome':'FCO','Madrid':'MAD','Barcelona':'BCN',
        'Lisbon':'LIS','Athens':'ATH','Stockholm':'ARN','Copenhagen':'CPH','Oslo':'OSL',
        'Helsinki':'HEL','Tallinn':'TLL','Riga':'RIX','Vilnius':'VNO','Moscow':'SVO',
        'Bucharest':'OTP','Sofia':'SOF','New York City':'JFK','Los Angeles':'LAX',
        'Chicago':'ORD','Dallas':'DFW','Houston':'IAH','Austin':'AUS','San Antonio':'SAT',
        'San Diego':'SAN','Phoenix':'PHX','Jacksonville':'JAX','Philadelphia':'PHL',
        'San Jose':'SJC','Toronto':'YYZ','Calgary':'YYC','Vancouver':'YVR',
        'Mexico City':'MEX','Tijuana':'TJS','Cancun':'CUN','Buenos Aires':'EZE',
        'Rio de Janeiro':'GIG','Bogotá':'BOG','Medellín':'MDE','Almaty':'ALA',
        'Sydney':'SYD','Melbourne':'MEL','Cape Town':'CPT'
      };

      // Reverse map: IATA → city name
      var IATA_CITY = {};
      Object.keys(CITY_IATA).forEach(function(c) { IATA_CITY[CITY_IATA[c]] = c; });

      // ---------------------------------------------------------------------------
      // Resolve city name — three sources, in priority order:
      //   1. Hash fragment  (#city=Istanbul)  — survives the renoo.me → www redirect
      //   2. Query string   (?city=Istanbul)  — works on localhost / direct links
      //   3. flightSearch token in query      (?flightSearch=SGN2002IST1)
      //      The widget opens resultsURL + "?flightSearch=<token>" in a new tab.
      //      Token format: ORIGIN(3) + DDMM(4) + DEST(3) + PAX(1+)
      //      We extract chars [7..10] as the destination IATA.
      // ---------------------------------------------------------------------------
      var city = '';

      // 1. Hash
      var hash = window.location.hash.replace(/^#/, '');
      if (hash) {
        try { city = new URLSearchParams(hash).get('city') || ''; } catch(e) {}
      }

      // 2. Query string (fallback)
      if (!city) {
        city = new URLSearchParams(window.location.search).get('city') || '';
      }

      // 3. flightSearch token (results-page fallback)
      var flightSearch = new URLSearchParams(window.location.search).get('flightSearch') || '';
      if (!city && flightSearch.length >= 10) {
        var destIATA = flightSearch.substring(7, 10).toUpperCase();
        city = IATA_CITY[destIATA] || '';
      }

      var iata = CITY_IATA[city] || '';

      // Legacy prefill config
      window.tpwlConfig = window.tpwlConfig || {};
      if (iata) window.tpwlConfig.destination = iata;

      window._travelCity  = city;
      window._travelIATA  = iata;
      window._IATA_CITY   = IATA_CITY;

      // ---------------------------------------------------------------------------
      // Intercept TPWL_BACKEND_CONFIGURATION assignment
      // The widget sets this property then reads it synchronously in the same tick.
      // A setTimeout poll always loses that race; a setter fires in time.
      //
      // resultsURL is set to plain "/travel.html" — the widget unconditionally
      // appends "?flightSearch=<token>" (always "?", never "&") so we cannot
      // put our own query params there.  The results page recovers the city from
      // the flightSearch token (source 3 above).
      //
      // showHotels is enabled so the widget renders the hotel checkbox and
      // generates proper affiliate booking.com URLs (aid + label params).
      // The hotel navigation is intercepted and opened in a new tab instead
      // of redirecting the current page (see tpwlBuyButtonClick + location patch).
      // ---------------------------------------------------------------------------

      // --- Hotel-navigation interceptor ----------------------------------
      // When the widget fires a hotel search it navigates the current tab to
      // a booking.com affiliate URL (aid + label params intact).  We want
      // that URL opened in a new tab instead so the user stays on renoo.me.
      //
      // Three layers, most-to-least reliable:
      //   1. onBuyButtonClick callback — widget calls window[name](url) before
      //      navigating.  We open in new tab and return true to suppress.
      //   2. location.assign / location.replace patches — the widget often
      //      navigates via one of these; we intercept booking.com URLs.
      //   3. window.open wrapper — catches any window.open(bookingURL) call.
      // Only booking.com URLs are intercepted; all other navigation is normal.
      // ------------------------------------------------------------------
      window.tpwlBuyButtonClick = function(url) {
        if (typeof url === 'string' && /booking\.com/i.test(url)) {
          window.open(url, '_blank');
          return true;
        }
        return false;
      };

      // Patch location.assign and location.replace to intercept booking.com
      (function() {
        var loc = window.location;
        var origAssign  = loc.assign.bind(loc);
        var origReplace = loc.replace.bind(loc);

        loc.assign = function(url) {
          if (typeof url === 'string' && /booking\.com/i.test(url)) {
            window.open(url, '_blank');
            return;
          }
          origAssign(url);
        };

        loc.replace = function(url) {
          if (typeof url === 'string' && /booking\.com/i.test(url)) {
            window.open(url, '_blank');
            return;
          }
          origReplace(url);
        };

        // Also wrap window.open so any booking.com open still goes to _blank
        var origOpen = window.open.bind(window);
        window.open = function(url, target, features) {
          if (typeof url === 'string' && /booking\.com/i.test(url)) {
            return origOpen(url, '_blank', features);
          }
          return origOpen(url, target, features);
        };
      })();

      var _realConfig = null;
      Object.defineProperty(window, 'TPWL_BACKEND_CONFIGURATION', {
        configurable: true,
        enumerable: true,
        set: function(val) {
          if (iata) {
            if (!val.flightParams) val.flightParams = {};
            val.flightParams.destination = iata;
          }
          // Enable hotel checkbox — affiliate URLs are generated by the widget.
          // Navigation to booking.com is intercepted by tpwlBuyButtonClick above.
          val.showHotels = true;
          val.resultsURL = '/travel.html';

          _realConfig = val;
          Object.defineProperty(window, 'TPWL_BACKEND_CONFIGURATION', {
            configurable: true, enumerable: true, writable: true, value: _realConfig
          });
        },
        get: function() { return _realConfig; }
      });
    })();
  </script>

  <!-- Travelpayouts White Label script -->
  <script data-noptimize="1" data-cfasync="false" data-wpfc-render="false">
    (function () {
          var script = document.createElement("script");
          script.async = 1;
          script.type = "module";
          script.src = "https://tpwgts.com/wl_web/main.js?wl_id=5242";
          document.head.appendChild(script);
        })();
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <title>Compare Travel Prices - Renoo.me</title>

  <!-- Open Graph -->
  <meta property="og:title" content="Renoo — Compare Medical Procedure Prices Worldwide" />
  <meta property="og:description" content="Find affordable medical treatments worldwide. Compare total costs including flights and hotels." />
  <meta property="og:image" content="https://renoo.me/og-image.jpg" />
  <meta property="og:url" content="https://renoo.me" />
  <meta property="og:type" content="website" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Renoo — Compare Medical Procedure Prices Worldwide" />
  <meta name="twitter:description" content="Find affordable medical treatments worldwide." />
  <meta name="twitter:image" content="https://renoo.me/og-image.jpg" />

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WXWMBBSK');</script>
  <!-- End Google Tag Manager -->

  <link rel="stylesheet" href="style.css?v=2">
</head>
<body class="city-page">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WXWMBBSK"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- Header -->
  <header class="fixed-header" id="fixedHeader">
    <div class="header-content">
      <div class="header-logo">
        <a href="/"><img src="/logo-white.svg" alt="Renoo.me" /></a>
      </div>
      <div class="city-page-title">✈️ Travel Prices</div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="city-main" style="padding-top: 80px;">
    <a href="#" class="travel-back-link" id="travelBackLink">← Back</a>

    <section class="city-header">
      <h1 class="city-name" id="travelPageTitle">✈️ Compare travel prices</h1>
      <p class="city-info" id="travelPageSubtitle">Find flights and hotels for your medical tourism trip</p>
    </section>

    <!-- Travelpayouts widget containers -->
    <div class="travel-widget-container">
      <div id="tpwl-search" data-destination=""></div>
      <div id="tpwl-tickets"></div>
      <div id="tpwl-modals"></div>
    </div>
  </main>

  <script>
    (function() {
      var city = window._travelCity || '';
      var iata = window._travelIATA || '';

      // Page title and subtitle
      if (city) {
        document.getElementById('travelPageTitle').textContent = '✈️ Compare travel prices to ' + city;
        document.getElementById('travelPageSubtitle').textContent = 'Search flights and hotels to ' + city + ' for your medical tourism trip';
        document.title = 'Travel Prices to ' + city + ' - Renoo.me';
      }

      // Prefill widget destination
      if (iata) {
        document.getElementById('tpwl-search').setAttribute('data-destination', iata);
      }

      // Back link: return to city page if we have a city, otherwise home
      var backLink = document.getElementById('travelBackLink');
      if (backLink) {
        backLink.href = city
          ? 'city.html?city=' + encodeURIComponent(city) + '&procedure=Botox'
          : '/';
      }
    })();
  </script>
</body>
</html>
